---
title: "Análise espacial usando R"
author: "Juliano Palacios Abrantes"
date: "Última atualização `r Sys.Date()`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(here)

source(paste0(here(),"/sessoes/funcoes_de_apoio/instalar_pacotes.R"))

packages <- c("tidyverse", 
              "sf", # for loading shapefiles
              "sp",
              "tools", # for loading shapefiles
              "here", # for easy paths
              "rnaturalearth",
              "viridis" # color-blind friendly pallets
              )

ipak(packages)

# Needs to convert to D2
# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

```

## Map sources

Existem inúmeras fontes de dados de mapas gratuitas e vários pacotes R que os integram bem. Uma das principais fontes que utilizo é o [shapefile do litoral com resolução de 10 m da Natural Earth] (http://www.naturalearthdata.com/downloads/10m-physical-vectors/). Você pode visitar o site para encontrar diferentes versões ou tipos de arquivos, e eles vêm principalmente em três formatos de resolução: 10m (fino), 50m (médio), 110m (grosso). A resolução se traduz diretamente em velocidade de mapeamento e processamento, com resoluções mais precisas demorando muito mais tempo. Como estou trabalhando em vários exemplos, usarei os mapas de resolução mais grosseira/mais baixa para a maioria deles.


### Global

Natural Earth também tem seu próprio pacote R chamado `rnaturalearth`

```{r, eval = T}

land110 <- ne_download(scale = 110, 
                       type = 'land', 
                       category = 'physical')

plot(land110)
```

Se você quiser preencher o terreno, você deve usar um shapefile de terreno. Se você quiser apenas o contorno dos continentes/ilhas, use um arquivo de litoral.

```{r, eval = T}

coast110 <- ne_download(scale = 110, 
                        type = 'coastline',
                         category = 'physical')
sp::plot(coast110)
```

Eles originalmente parecem iguais, mas se você convertê-los em um objeto de "recursos simples" (`sf`), poderá ver a diferença.

```{r, eval = T}

land110_sf <- st_as_sf(land110)

# Land shapefile
ggplot(land110_sf) + 
  geom_sf(fill="blue")

coast110_sf <- st_as_sf(coast110)

# Coastal lines shapefile
ggplot(coast110_sf) + 
  geom_sf(color="blue")
```

Alternativamente, você pode querer dados em nível de país, como ao fazer um mapa mundial.

```{r, eval = T}

country110 <- ne_countries() #natural earth countries

country110_sf <- st_as_sf(country110)

ggplot(country110_sf) + 
  geom_sf(aes(fill = as.factor(mapcolor9))) +
  theme(legend.position="none") + # Legend wont show up (try change it to 'right')
  scale_fill_brewer(palette="Greys")

# Maybe you want a map all grey
ggplot(country110_sf) + 
  geom_sf(fill="grey50") +
  theme(legend.position="none")



```

### Regional

Mas é difícil ver o que está acontecendo em um nível menor com esses dados de nível mundial. Você tem duas opções:  

1. Amplie um subconjunto do mapa atual.   
1. Encontre um mapa em menor escala que seja da sua área de interesse.   

Outra boa fonte de dados a nível de país, incluindo subunidades, é http://www.diva-gis.org/gdata


```{r crop, eval = T}

dims <- c(xmin=-100, xmax=-30,  # Longitude minima e maxima
          ymin=-60, ymax=12 # Latitude minima e maxima
          )

ame_sul <- st_crop(x=country110_sf, 
                 y=dims)

ame_sul %>% ggplot() + 
  geom_sf()
```

Percebe problemas com este mapa?

1. Faltam ilhas 
2. O litoral é muito suave.   
3. Geralmente irrealista.  

Vamos usar um mapa mais detalhado... 

```{r, eval = T}

country10_sf <- ne_download(scale=10, 
                            type="countries",
                            category="cultural", 
                            returnclass="sf")

ame_sul_det <- st_crop(x=country10_sf, y=dims)

ame_sul_det %>% ggplot() + 
   geom_sf()
```


Naturalmente, você também pode filtrar o país desejado porque o pacote `sf` funciona muito bem com `dplyr`

```{r, eval = T}

# head(country10_sf)
brasil <- country10_sf %>% 
  filter(NAME == "Brazil")

ggplot(brasil) + 
  geom_sf()

```

### País

A se eu quero um area ainda mais pequena?

Maneiras de corrigir isso: 
1. Use o mapa mundial de maior resolução ao trabalhar nesta escala
2. Use um mapa regional de resolução mais precisa.

```{r sub_national, eval = T}

# ?ne_download
states <- ne_states()
states_sf <- st_as_sf(states)

states_sf_br <- states_sf %>% 
  filter(iso_a2=="BR") #Filtre para um país, caso contrário, levará uma eternidade.

ggplot(states_sf_br) + 
  geom_sf()

```

Então, se o que importa para mim é só RGN... Primeiro vamos descobrir os nomes (nem sempre é fácil)


```{r}
unique(states_sf_br$name)

```


Agora sim, sabemos que RGN ta como *Rio Grande do Norte*... 

```{r rgn, eval = T}

states_sf_br %>% 
  filter(name == "Rio Grande do Norte") %>% 
  ggplot() +
  geom_sf()

```

You can also load your own shapefile (DO NOT RUN)

```{r load-map}

path_sf <- here("data/espacial/fao_areas")

# The File
name_sf <- "FAO_AREAS_CWP.shp"

# Load it!
fao_areas_sf <- st_read(dsn = path_sf,
                        layer =file_path_sans_ext(name_sf))

# Explor it
names(fao_areas_sf)
# head(FAO_Areas_sf)

# And plot it (will take a little bit)
ggplot(fao_areas_sf) +
  geom_sf()

```


## Time is essence... 

While you can do all the maps that you want with R, it is not the best tool for visualization. It can actually take for-ever to show you a map (as we are swing now)



## Use of maps in science

- Reference maps (classic figure 1)
- Raster maps
- Geographic entity maps
- Maps with data on top (dots, lines, etc.)


## Reference Maps
Reference maps are often used to orient the audience to a study area they may be unfamiliar with. These are most effective when they situate it within some kind of knowledge that they have already. Thus, they often use a small scale and a large scale map. 

```{r reference-map}

# Random Samples along the coast

Samples <- data.frame(
  Lat = c(41.99,42.3,42.5,43.73,43.4,43.3),
  Long = c(-8.9,-8.9,-8.9,-8,-8.4,-9)
)


states_sf_es %>% 
  filter(region == "Galicia") %>% 
  ggplot() + 
  geom_sf(
    aes(fill = name)
  ) + 
  geom_point(data = Samples,
             aes(
               x = Long,
               y = Lat
             ),
             color = "black"
  ) +
  theme_minimal() +
  scale_fill_brewer("Provincia", palette = "Set3")

```


## Raster Maps
Rasters are simplifications of spatial data according to a certain resolution size. 

```{r}

states_sf_es %>% 
  ggplot() +
  geom_sf(
    aes(fill=diss_me)
  ) +
  scale_fill_distiller(palette = "Spectral") +
  theme_minimal()

```

## Geographic Entity Maps

We've already made one of these that was filled on a map feature. The main point with these is having a column attached to your dataframe that you are interested in plotting. Then, the polygons are filled based on that. 

```{r}
#WARNING: EXAMPLE USES FAKE DATA 
# head(states_sf_es)
names(states_sf_es)

# Create dummy dataset
df <- tibble(adm1_code= states_sf_es$adm1_code, 
             Fish_Lovers = rnorm(nrow(states_sf_es), mean=20000, sd=1000))

# Join our data with the shapefile
states_sf_es <- left_join(states_sf_es, 
                          df)

names(states_sf_es)

states_sf_es %>% 
  ggplot() + 
  geom_sf(aes(fill=Fish_Lovers)) + 
  scale_fill_distiller(palette = "Spectral",
                       breaks= seq(min(states_sf_es$Fish_Lovers),max(states_sf_es$Fish_Lovers), 1000)
                       ) +
  theme_minimal()


```


## Maps with Data on Top
These are actually fairly simple to make in R. Make your map, add your data! 

```{r}

map <- states_sf_es %>% 
  filter(name == "Pontevedra") %>% 
  ggplot() +
  geom_sf()

df <- tibble(lon = c(-9, -9.2, -8.7,-8.6),
             lat = c(42, 42.1, 42.3, 42.3),
             value = c("water", "water", "land","land"))

map + 
  geom_point(data=df, 
             aes(x=lon, 
                 y=lat, 
                 color=value), 
             size=2) +
  theme_bw()


```

## Combining different map layers

Combining different layers on a map is *fairly* simple. You start with your base map layer, and then you add the different `geom_` layers as you like.

```{r}

# made up catch data

df <- tibble(lon = c(runif(25, min=-20, max=-8.6),runif(25, min=2, max=20)),
             lat = runif(50, min=36, max=46),
             Catch = runif(50, min=100, max=1000)
             )



# The Spain's map croped to what I want to show
Spain <- ne_download(scale=10, 
                     type="countries",
                     category="cultural", 
                     returnclass="sf") %>% 
  filter(NAME == "Spain") 

# Looks weird to only have a floating Spain
Others <- ne_download(scale=50, 
                      type="countries",
                      category="cultural", 
                      returnclass="sf") %>% 
  filter(NAME %in% c("France","Portugal"))

# Then FAO Regions layer
FAO_Areas <- FAO_Areas_sf %>% 
  filter(
    ID %in% c(98,72,278,21) # sub regions around spain
  ) %>% 
  mutate(Name_Clear = gsub( " *\\(.*?\\) *", "", NAME_EN), # create nice names
         Name_Clear = gsub("\\/.*","",Name_Clear))

# Now we make the plot
ggplot() +
  # Spain Land mass
  geom_sf(data = Spain, fill = "grey50") + 
  # France and Portugal
  geom_sf(data = Others, fill = "grey90") + 
  # FAO Regions by surface area
  geom_sf(data = FAO_Areas,  
          aes(fill = SURFACE)
  ) +
  # Add lables to FAO Areas
  geom_sf_label(data = FAO_Areas, 
                aes(label = Name_Clear,
                    fill = SURFACE)
  ) +
  # Add particular catch points
  geom_point(data = df,
             aes(
               x = lon,
               y = lat,
               size = Catch
             ),
             shape = 21,
             fill = "transparent",
             colour = "grey40"
  ) +
  # Add Spain's name
  annotate("text", 
           x = -4, 
           y = 40, 
           label = "Spain",
           colour = "darkred",
           size = 6) + 
  # Inlcude color-blind friendly scale
  scale_fill_viridis("Landings \n (Tonnes)",
                     option = "viridis") +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "transparent")
  ) +
  # Crop the map to what we want to show
  ylim(33.9,50.3) +
  xlim(-20,20)


```


## Some extra points

`st_simplify()`

```{r, eval=F}

x <- st_simplify(states_sf_pe, dTolerance = 0.1)
ggplot(x) + geom_sf()

x <- st_simplify(states_sf, dTolerance = 0.1)

ggplot(x) + geom_sf()
```